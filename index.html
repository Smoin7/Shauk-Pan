/************************************
 * GLOBAL CART
 ************************************/
const cart = {};
const panPriceMap = {};

const INVENTORY_API =
  "https://shaikh98.app.n8n.cloud/webhook/pan-inventory";

/************************************
 * ORDER TYPE
 ************************************/
function toggleAddress() {
  const orderType = document.getElementById("orderType").value;
  const addressBox = document.getElementById("addressBox");

  addressBox.style.display = orderType === "delivery" ? "block" : "none";
  if (orderType === "pickup") {
    document.getElementById("address").value = "";
  }
}

/************************************
 * LOAD INVENTORY
 ************************************/
function loadPanInventory() {
  const select = document.getElementById("item");
  select.innerHTML = `<option>Loading...</option>`;

  fetch(INVENTORY_API)
    .then(res => res.json())
    .then(data => {
      select.innerHTML = `<option value="">-- Select Paan --</option>`;
      data.pans.forEach(pan => {
        panPriceMap[pan.name] = pan.price;
        const opt = document.createElement("option");
        opt.value = pan.name;
        opt.textContent = `${pan.name} (₹${pan.price})`;
        select.appendChild(opt);
      });
    });
}

document.addEventListener("DOMContentLoaded", () => {
  toggleAddress();
  loadPanInventory();
});

/************************************
 * ADD ITEM
 ************************************/
function addItem() {
  const pan = item.value;
  const qty = parseInt(qtyInput.value || qty.value);

  if (!pan || qty <= 0) {
    alert("Select item and quantity");
    return;
  }

  if (cart[pan]) {
    alert("Item already added");
    return;
  }

  cart[pan] = { qty, price: panPriceMap[pan] };
  renderCart();
}

const qtyInput = document.getElementById("qty");

/************************************
 * RENDER CART
 ************************************/
function renderCart() {
  const ul = document.getElementById("cart");
  const totalEl = document.getElementById("totalPrice");

  ul.innerHTML = "";
  let total = 0;

  for (let pan in cart) {
    const line = cart[pan].qty * cart[pan].price;
    total += line;

    ul.innerHTML += `
      <li>
        ${pan} × ${cart[pan].qty} = ₹${line}
        <button onclick="removeItem('${pan}')">✖</button>
      </li>`;
  }

  totalEl.innerText = total;
}

function removeItem(pan) {
  delete cart[pan];
  renderCart();
}

/************************************
 * BOOK NOW (FIXED)
 ************************************/
function bookNow() {
  const name = document.getElementById("name").value.trim();
  const mobile = document.getElementById("mobile").value.trim();
  const orderType = document.getElementById("orderType").value;
  const address = document.getElementById("address").value.trim();
  const branch = document.getElementById("branch").value;

  if (!name || !mobile || !branch) {
    alert("Fill all required details");
    return;
  }

  if (orderType === "delivery" && !address) {
    alert("Enter delivery address");
    return;
  }

  if (Object.keys(cart).length === 0) {
    alert("Add at least one item");
    return;
  }

  const items = [];
  let total = 0;

  for (let pan in cart) {
    const t = cart[pan].qty * cart[pan].price;
    total += t;
    items.push({ pan, ...cart[pan], total: t });
  }

  const orderData = {
    name,
    mobile,
    orderType,
    address,
    branch,
    items,
    total
  };

  localStorage.setItem("shaukPaanOrder", JSON.stringify(orderData));
  window.location.href = "payment.html";
}
