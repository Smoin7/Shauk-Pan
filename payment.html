<script>
document.addEventListener("DOMContentLoaded", () => {

  const DELIVERY_CHARGE = 50;

  const raw = localStorage.getItem("shaukPaanPendingOrder");

  if (!raw) {
    alert("No order found. Please place order again.");
    return; // ❌ DO NOT redirect immediately
  }

  const order = JSON.parse(raw);

  // ✅ Generate Order ID
  const orderId = "SP" + Date.now();

  let itemsHtml = "";
  let itemsTotal = 0;

  order.items.forEach(item => {
    itemsTotal += item.lineTotal;
    itemsHtml += `
      <div style="display:flex;justify-content:space-between">
        <span>${item.item} × ${item.qty}</span>
        <span>₹${item.lineTotal}</span>
      </div>
    `;
  });

  const isDelivery = order.orderType === "delivery";
  const deliveryCharge = isDelivery ? DELIVERY_CHARGE : 0;
  const finalTotal = itemsTotal + deliveryCharge;

  document.getElementById("orderDetails").innerHTML = `
    <p><b>Order ID:</b> ${orderId}</p>
    <p><b>Name:</b> ${order.name}</p>
    <p><b>Mobile:</b> ${order.mobile}</p>
    <p><b>Order Type:</b> ${order.orderType}</p>
    <p><b>Branch:</b> ${order.branch}</p>
    ${isDelivery ? `<p><b>Address:</b> ${order.address}</p>` : ""}

    <hr>
    ${itemsHtml}
    ${isDelivery ? `<p>Delivery Charge: ₹${deliveryCharge}</p>` : ""}
    <h3>Total: ₹${finalTotal}</h3>
  `;

  window.confirmOrder = async function () {
    const payload = {
      orderId,
      ...order,
      deliveryCharge,
      totalAmount: finalTotal
    };

    try {
      const res = await fetch(
        "https://shaikh98.app.n8n.cloud/webhook/pan-order",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }
      );

      if (!res.ok) throw new Error();

      alert("✅ Order placed successfully");
      localStorage.removeItem("shaukPaanPendingOrder");
      window.location.href = "index.html";

    } catch {
      alert("❌ Failed to place order");
    }
  };

});
</script>
